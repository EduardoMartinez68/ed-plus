<style>
.pop-cfdi-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75); /* fondo negro opaco */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
}

.pop-cfdi-card {
  position: relative;
  background: #fff;
  width: 360px;
  max-width: 90%;
  padding: 20px 24px;
  border-radius: 6px;
  text-align: center;
  font-family: Arial, sans-serif;
  box-sizing: border-box;
}

/* Bot√≥n cerrar tipo 'X' en esquina */
.pop-cfdi-btn-close {
  position: absolute;
  top: 8px;
  right: 10px;
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #444;
  line-height: 1;
  padding: 0;
  user-select: none;
}

/* Botones estilo minimalista y full width */
.pop-cfdi-btn {
  width: 100%;
  padding: 11px 0;
  margin: 8px 0;
  border: none;
  cursor: pointer;
  font-size: 15px;
  border-radius: 5px;
  font-weight: 600;
  color: #fff;
  user-select: none;
  transition: background-color 0.2s ease;
}

.pop-cfdi-btn-pdf {
  background-color: #0d6efd; /* azul bootstrap */
}
.pop-cfdi-btn-pdf:hover {
  background-color: #0b5ed7;
}

.pop-cfdi-btn-xml {
  background-color: #6c757d; /* gris */
}
.pop-cfdi-btn-xml:hover {
  background-color: #5c636a;
}

.pop-cfdi-btn-email {
  background-color: #198754; /* verde */
}
.pop-cfdi-btn-email:hover {
  background-color: #157347;
}
</style>

<div class="pop-cfdi-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="popCfdiTitle">
  <div class="pop-cfdi-card">
    <button class="pop-cfdi-btn-close" id="popCfdiCloseBtn" aria-label="Cerrar">&times;</button>
    <h5 id="popCfdiTitle" style="margin-bottom: 16px;">‚úÖ Factura creada correctamente</h5>
    <p style="margin-bottom: 20px;">¬øQu√© deseas hacer con la factura?</p>
    <button id="popCfdiBtnPdf" class="pop-cfdi-btn pop-cfdi-btn-pdf">üìÑ Descargar PDF</button>
    <button id="popCfdiBtnXml" class="pop-cfdi-btn pop-cfdi-btn-xml">üìÑ Descargar XML</button>
    <button id="popCfdiBtnEmail" class="pop-cfdi-btn pop-cfdi-btn-email">üì§ Enviar por correo</button>
  </div>
</div>

<script>
function mostrarPopupFactura(idFactura) {
  const overlay = document.querySelector('.pop-cfdi-overlay');
  overlay.style.display = 'flex';

  guardar_facture(idFactura);
    document.getElementById('popCfdiBtnPdf').onclick = () => {
        console.log("Descargar PDF:", idFactura);
        descargarFactura(idFactura, 'pdf');
    };

    document.getElementById('popCfdiBtnXml').onclick = () => {
        console.log("Descargar XML:", idFactura);
        descargarFactura(idFactura, 'xml');
    };

    document.getElementById('popCfdiBtnEmail').onclick = () => {
        console.log("Enviar por correo:", idFactura);
        // Aqu√≠ luego agregaremos la l√≥gica para enviar por correo
    };
}

// Funci√≥n que usar√°s para guardar en base de datos
function guardar_facture(idFactura) {
  console.log("Guardando factura con ID:", idFactura);
  // Aqu√≠ tu fetch o l√≥gica para guardar la factura
}

// Cerrar popup
document.getElementById('popCfdiCloseBtn').onclick = () => {
  document.querySelector('.pop-cfdi-overlay').style.display = 'none';
};

async function descargarFactura(id, formato) {
    try {
        const response = await fetch('https://pluspuntodeventa.com/api/factura/descargar_factura.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: id, formato: formato })
        });

        if (!response.ok) {
            throw new Error("Error al descargar archivo");
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `factura_${id}.${formato}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

    } catch (error) {
        console.error("‚ùå Error al descargar la factura:", error.message);
    }
}

</script>
