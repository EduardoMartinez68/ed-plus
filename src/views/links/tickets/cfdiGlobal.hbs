<style>
    .card {
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
    }

    label {
        font-weight: 600;
        margin-bottom: 4px;
    }

    input[readonly],
    input[disabled] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .form-section {
        margin-bottom: 15px;
    }

    #selectDatePersonality .btn {
        width: 100%;
    }

    .modal-header {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .modal-footer {
        margin-top: 10px;
    }

    .input-date {
        background-color: white !important;
        border: none;
        outline: none;
        box-shadow: none;
        color: #212529;
        /* texto oscuro (puedes cambiarlo) */
        padding: 0;
        font-size: 1rem;
        pointer-events: none;
        /* evita que el usuario intente interactuar */
    }
</style>
<style>
    table.simple-table {
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        font-size: 14px;
        background-color: #fff;
        color: #333;
    }

    .simple-table th,
    .simple-table td {
        border-bottom: 1px solid #ddd;
        text-align: left;
        padding: 8px 10px;
    }

    .simple-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .summary {
        margin-top: 15px;
        font-family: Arial, sans-serif;
        color: #333;
    }

    .summary h6 {
        font-size: 14px;
        margin: 0;
        font-weight: normal;
    }

    .summary h4 {
        font-size: 18px;
        margin: 4px 0 0 0;
        font-weight: bold;
    }
</style>

<div class="container mt-4">
    <div class="card p-3">
        <label for="">Ь Genera una factura Global</label>
        <hr>
        <div class="row">
            <div class="col">
                <div class="form-group form-section">
                    <info-label label="Selecciona los Documentos a Facturar *"
                        message="Solo se incluir谩n los tickets que a煤n no han sido facturados.">
                    </info-label>
                    <select id="dataTypeFactureGlobal" class="form-select">
                        <option value="1">Facturar las ventas de todos los clientes</option>
                        <option value="2">Facturar las ventas solo del publico en general</option>
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="form-group form-section">
                    <info-label label="Selecciona el periodo de tiempo de los tickets que deseas facturar. *"
                        message="Solo se incluir谩n los tickets generados dentro de este rango de fechas.">
                    </info-label>
                    <select id="dateRangeSelect" class="form-select">
                        <option value="1">Hoy</option>
                        <option value="2">ltimos 7 d铆as</option>
                        <option value="3">Mes actual</option>
                        <option value="4">Mes anterior</option>
                        <option value="5">Personalizado</option>
                    </select>
                </div>
            </div>
        </div>
        <hr>
        <div class="form-group">
            <label for="">Desde </label><input type="date" id="dateFrom" readonly disabled class="input-date"><label for="">Hasta </label><input type="date" id="dateTo" readonly disabled class="input-date">
            <br>
            <label for="">Meses a Facturar: </label><label for="" id="Months"></label>
        </div>
        <div id="settingFacture" class="my-pop">
            <div class="my-pop-content-wrapper">
                <div class="my-pop-header">
                    <h4 class="my-pop-title">Ajuste de Facturaci贸n</h4>
                    <button class="close-btn" onclick="close_my_pop('settingFacture')" type="button"></button>
                </div>
                <div class="my-pop-content">
                    {{>cfdi/settingFactureCFDIGlobalInfo}}
                </div>
            </div>
        </div>
        <div class="btn-div" onclick="open_my_pop('settingFacture')">
            <div class="btn-div-content">
                <label><i class="fi fi-ss-file-invoice-dollar"></i> Datos de la Factura</label>
                <p>Mis Datos personales de facturaci贸n</p>
            </div>
            <i class="fi fi-rr-angle-right"></i>
        </div>



        <div id="settingFactureTicket" class="my-pop">
            <div class="my-pop-content-wrapper">
                <div class="my-pop-header">
                    <h4 class="my-pop-title">Ajuste de Facturaci贸n</h4>
                    <button class="close-btn" onclick="close_my_pop('settingFactureTicket')" type="button"></button>
                </div>
                <div class="my-pop-content">
                    {{>cfdi/settingFactureCFDIGlobal}}
                </div>
            </div>
        </div>
        <div class="btn-div" onclick="open_my_pop('settingFactureTicket')">
            <div class="btn-div-content">
                <label><i class="fi-icon fi-rr-settings-sliders"></i> Filtra los documentos a facturar</label>
                <p>Todos</p>
            </div>
            <i class="fi fi-rr-angle-right"></i>
        </div>
        <br><br><br><br><br><br><br>
        <div class="row">
            <div class="col">
                <div class="form-group form-section">
                    <info-label label="Periodicidad *"
                        message="Campo requerido para registrar el per铆odo al que corresponde la informaci贸n del comprobante global">
                    </info-label>
                    <select id="Periodicity" class="form-select">
                        <option value="01">01 - Diario</option>
                        <option value="02">02 - Semanal</option>
                        <option value="03">03 - Quincenal</option>
                        <option value="04">04 - Mensual</option>
                        <option value="05">05 - Bimestral</option>
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="form-group form-section">
                    <info-label label="A帽o de la factura *"
                        message="Se debe registrar el a帽o al que corresponde la informaci贸n del comprobante global">
                    </info-label>
                    <input type="number" id="Year" class="form-control" min="1900" max="2100" placeholder="Ej: 2025">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="form-group form-section">
                    <info-label label="Forma de Pago *"
                        message="Clave de la forma de pago con la que se liquid贸 el comprobante de operaciones con el p煤blico en general de mayor monto de entre los contenidos en el CFDI global">
                    </info-label>
                    <select name="formaPago" class="form-select" required id="PaymentForm">
                        <option value="01">01 - Efectivo</option>
                        <option value="02">02 - Cheque nominativo</option>
                        <option value="03">03 - Transferencia electr贸nica de fondos</option>
                        <option value="04">04 - Tarjeta de cr茅dito</option>
                        <option value="05">05 - Monedero electr贸nico</option>
                        <option value="06">06 - Dinero electr贸nico</option>
                        <option value="08">08 - Vales de despensa</option>
                        <option value="12">12 - Daci贸n en pago</option>
                        <option value="13">13 - Pago por subrogaci贸n</option>
                        <option value="14">14 - Pago por consignaci贸n</option>
                        <option value="15">15 - Condonaci贸n</option>
                        <option value="17">17 - Compensaci贸n</option>
                        <option value="23">23 - Novaci贸n</option>
                        <option value="24">24 - Confusi贸n</option>
                        <option value="25">25 - Remisi贸n de deuda</option>
                        <option value="26">26 - Prescripci贸n o caducidad</option>
                        <option value="27">27 - A satisfacci贸n del acreedor</option>
                        <option value="28">28 - Tarjeta de d茅bito</option>
                        <option value="29">29 - Tarjeta de servicios</option>
                        <option value="30">30 - Aplicaci贸n de anticipos</option>
                        <option value="99">99 - Por definir</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="btn btn-add" onclick="create_data_facture()">Crear Factura Global</button>
    </div>

</div>

<!-- Modal personalizado -->
<div id="selectDatePersonality" class="my-pop">
    <div class="my-pop-content-wrapper">
        <div class="my-pop-header">
            <h4 class="my-pop-title">Seleccionar Rango Personalizado</h4>
            <button class="close-btn" onclick="close_my_pop('selectDatePersonality')" type="button"></button>
        </div>
        <div class="my-pop-content">
            <div class="form-group">
                <label for="customStart">Fecha inicial</label>
                <input type="date" id="customStart" class="form-control">
            </div>
            <div class="form-group">
                <label for="customEnd">Fecha final</label>
                <input type="date" id="customEnd" class="form-control">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="applyCustomRange">Aceptar</button>
            </div>
            <br><br>
        </div>
    </div>
</div>
<br><br><br>
<script>
    document.getElementById('Year').value = new Date().getFullYear();

    //her update the data of the month
    const now = new Date();
    const currentMonth = String(now.getMonth() + 1).padStart(2, '0'); // getMonth() es de 0 a 11
    document.getElementById('Months').textContent = currentMonth;


    const dateRangeSelect = document.getElementById("dateRangeSelect");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const customModal = document.getElementById("customRangeModal");
    const applyCustomBtn = document.getElementById("applyCustomRange");

    dateRangeSelect.addEventListener("change", function () {
        const today = new Date();
        let startDate, endDate;

        switch (this.value) {
            case "1": // Hoy
                startDate = endDate = today;
                update_date_today();
                break;
            case "2": // ltimos 7 d铆as
                endDate = today;
                startDate = new Date();
                startDate.setDate(endDate.getDate() - 6);
                break;
            case "3": // Mes actual
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case "4": // Mes anterior
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                break;
            case "5": // Personalizado
                //customModal.style.display = "block";
                open_my_pop('selectDatePersonality');
                return;
        }
        update_data_month(startDate, endDate)

        if (this.value !== "5") {
            const format = (d) => d.toISOString().split('T')[0];
            dateFrom.value = format(startDate);
            dateTo.value = format(endDate);
            //customModal.style.display = "none";
            close_my_pop('selectDatePersonality');
        }
    });

    function update_data_month(startDate, endDate) {
        const months = [];
        const start = new Date(startDate);
        const end = new Date(endDate);

        // Normalizar al primer d铆a del mes
        start.setDate(1);
        end.setDate(1);

        // Recorrer cada mes entre startDate y endDate
        while (start <= end) {
            const month = String(start.getMonth() + 1).padStart(2, '0');
            if (!months.includes(month)) months.push(month);
            start.setMonth(start.getMonth() + 1);
        }

        // Unir los meses por coma si hay m谩s de uno
        document.getElementById('Months').textContent = months.join(',');
    }

    function update_date_today(){
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0]; // Formato YYYY-MM-DD

        document.getElementById('dateFrom').value = formattedDate;
        document.getElementById('dateTo').value = formattedDate;
    }
    update_date_today();

    applyCustomBtn.addEventListener("click", () => {
        const start = document.getElementById("customStart").value;
        const end = document.getElementById("customEnd").value;

        if (!start || !end) {
            alert("Por favor selecciona ambas fechas.");
            return;
        }

        if (start > end) {
            alert("La fecha inicial no puede ser mayor que la final.");
            return;
        }

        dateFrom.value = start;
        dateTo.value = end;
        //customModal.style.display = "none";
        close_my_pop('selectDatePersonality');

         const dateStart = new Date(start);
         dateStart.setMonth(dateStart.getMonth() + 1);
         //const nextMonth = dateStart.toISOString().split("T")[0];


        update_data_month(dateStart, end)
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const Periodicity = document.getElementById("Periodicity");
    const fiscalInput = document.getElementById("FiscalRegime");

    if (!Periodicity || !fiscalInput) {
        console.warn("No se encontraron los elementos necesarios");
        return;
    }

    const originalFiscalValue = fiscalInput.value;

    // Asignar valor inicial si ya est谩 en 05
    if (Periodicity.value === "05") {
        fiscalInput.value = "621";
    }

    Periodicity.addEventListener("change", function () {
        if (Periodicity.value === "05") {
            fiscalInput.value = "621";
        } else {
            fiscalInput.value = originalFiscalValue;
        }
    });
});
</script>
<script>
    async function create_data_facture(){
        /*
        {	    
            "Items": [{        
                "ProductCode": "25173108",
                "Description": "GPS estandar pruebas",
                "UnitCode": "E48",
                "Quantity": 1.0,
                "UnitPrice": 100.0,
                "Subtotal": 100.00,
                "TaxObject" : "02",
                "Taxes": [{
                    "Total": 16,
                    "Name": "IVA",
                    "Base": 100,
                    "Rate": 0.16,
                    "IsRetention": false
                }],
                "Total": 116
            }]	
        }
        */
        const allTheItems=await get_all_the_tickets();

        const dataCFDI={
            CfdiType:'I',
            PaymentForm: document.getElementById('PaymentForm').value,
            PaymentMethod: "PUE",
            ExpeditionPlace : document.getElementById('ExpeditionPlace').value,
            Date:create_date_folio(),
            Folio: create_folio(),
            GlobalInformation: get_global_information(),
            Receiver: get_data_receiver(),
            Items: allTheItems
        }
    }

    function create_folio(){
        return 120
    }

    function create_date_folio(){
        const now = new Date();

        const formattedDate = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0');

        return formattedDate;
    }

    function get_global_information(){
        return {
            Periodicity:document.getElementById('Periodicity').value,
            Months:document.getElementById('Months').textContent,
            Year:document.getElementById('Year').value,
        }
    }

    function get_data_receiver(){
        return {
            Rfc: "XAXX010101000",
            CfdiUse: "S01",
            Name: "PUBLICO EN GENERAL",
            FiscalRegime: document.getElementById('FiscalRegime').value,
            TaxZipCode : document.getElementById('ExpeditionPlace').value
        }
    }

    async function get_all_the_tickets(){
        const range_date=get_range_date()
        const answer=await send_data_to_server('/links/get_data_of_tickets_for_date', range_date);
        if(answer.success){
            return answer.data;
        }else{
            return null;
        }
    }

    function get_range_date(){
        const date_start=document.getElementById('dateFrom').value;
        const date_finish=document.getElementById('dateTo').value;
        return {
            date_start,
            date_finish
        }
    }
</script>