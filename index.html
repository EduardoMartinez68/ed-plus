<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>POS Báscula Web Serial</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { padding: 5px; font-size: 16px; margin: 5px 0; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

  <h2>Conectar Báscula</h2>

  <label for="baudRate">Baud Rate:</label>
  <input type="number" id="baudRate" min="300" max="115200" step="100" />
  <button id="guardarBaud">Guardar BaudRate</button>
  <br><br>

  <button id="conectar">Conectar Báscula</button>
  <p><strong>Peso actual:</strong></p>
  <input id="peso" readonly />

  <script>
    let port;
    let reader;

    // Cargar baudRate guardado desde localStorage (o usar 9600 por defecto)
    const baudInput = document.getElementById("baudRate");
    baudInput.value = localStorage.getItem("baudRate") || 9600;

    // Guardar nuevo baudRate en localStorage
    document.getElementById("guardarBaud").addEventListener("click", () => {
      const nuevoBaud = parseInt(baudInput.value);
      if (isNaN(nuevoBaud) || nuevoBaud < 300 || nuevoBaud > 115200) {
        alert("BaudRate inválido. Usa un valor entre 300 y 115200.");
        return;
      }
      localStorage.setItem("baudRate", nuevoBaud);
      alert("BaudRate guardado: " + nuevoBaud);
    });

    document.getElementById("conectar").addEventListener("click", async () => {
      try {
        const baudRate = parseInt(localStorage.getItem("baudRate")) || 9600;

        // Solicita al usuario seleccionar el puerto
        port = await navigator.serial.requestPort();
        await port.open({ baudRate });

        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();

        // Leer datos continuamente
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const peso = parseFloat(value.replace(/[^\d.]/g, ''));
            if (!isNaN(peso)) {
              document.getElementById("peso").value = peso.toFixed(2);
            }
          }
        }

      } catch (err) {
        alert("Error al conectar la báscula: " + err);
        console.error(err);
      }
    });
  </script>
</body>
</html>
