<br><br>
<style>
    .editor,
    .preview {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 800px;
        margin: 10px auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2,
    h3 {
        text-align: center;
    }

    label {
        display: block;
        margin-top: 10px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
        width: 100%;
        padding: 6px;
        margin-top: 5px;
    }

    .checkbox-group {
        margin-top: 10px;
    }

    .ticket-preview {
        border: 1px dashed #ccc;
        padding: 10px;
        background: #fff;
        text-align: center;
    }

    .ticket {
        max-width: 300px;
        margin: auto;
        font-size: 16px;
    }

    .logo {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .product-table {
        width: 100%;
        margin: 10px 0;
        border-top: 1px dashed #000;
        border-bottom: 1px dashed #000;
    }

    .product-table th,
    .product-table td {
        padding: 3px;
        text-align: center;
    }

    .qr img {
        margin-top: 10px;
        width: 120px;
        height: 120px;
    }

    button {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 16px;
    }

    .hidden {
        display: none;
    }
</style>

{{#each dataCompany}}
<input type="hidden" value="{{name}}" id="name_company">
<img src="{{path_logo}}" alt="" id="icon_company" class="hidden">
<input type="hidden" value="{{email_company}}" id="email_company">
{{/each}}
{{#each branchFree}}
<input type="hidden" value="{{name_branch}}" id="name_branch">
<input type="hidden" value="{{address}}" id="address">
<input type="hidden" value="{{cell_phone}}" id="cell_phone">
<input type="hidden" value="{{phone}}" id="phone">
<input type="hidden" value="{{email_branch}}" id="email_branch">
{{/each}}



<div class="container">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <label for=""><i class="fi fi-ss-receipt"></i> Tickets</label>
                <hr>
            </div>
            <div class="row">
                <div class="col">
                    {{#each settingTicket}}
                    <form action="/links/:id_companies/:id_branches/:id/update_ticket" method="post">
                    {{/each}}
                        <div class="editor">
                            <div class="row">
                                <label>Seleccionar impresora:</label>
                                <select id="impresoraSelect" class="form-select"
                                    aria-label="Default select example"></select>
                            </div>
                            <label>Tamaño del Ticket (mm):</label>
                            <input type="number" id="ticketWidth" value-ticket="{{settingTicket.size_ticket}}" placeholder="80" class="form-control" name="size_ticket">

                            <div class="form-check">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarLogo" value-ticket="{{settingTicket.show_logo}}" name="show_logo">
                                    <label class="form-check-label" for="mostrarLogo">Mostrar logo</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarFecha" value-ticket="{{settingTicket.show_date}}" name="show_date">
                                    <label class="form-check-label" for="mostrarFecha">Mostrar fecha</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="show_employee" value-ticket="{{settingTicket.show_name_employee}}" name="show_name_employee">
                                    <label class="form-check-label" for="show_employee">Mostrar nombre del empleado</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="show_customer" value-ticket="{{settingTicket.show_name_customer}}" name="show_name_customer">
                                    <label class="form-check-label" for="show_customer">Mostrar nombre del cliente</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarNombreEmpresa" value-ticket="{{settingTicket.show_name_company}}" name="show_name_company">
                                    <label class="form-check-label" for="mostrarNombreEmpresa">Mostrar nombre de la empresa</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarDireccion" value-ticket="{{settingTicket.show_address}}" name="show_address">
                                    <label class="form-check-label" for="mostrarDireccion">Mostrar dirección</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarSucursal" value-ticket="{{settingTicket.show_name_branch}}" name="show_name_branch">
                                    <label class="form-check-label" for="mostrarSucursal">Mostrar nombre de la sucursal</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarTelefono" value-ticket="{{settingTicket.show_phone}}" name="show_phone">
                                    <label class="form-check-label" for="mostrarTelefono">Mostrar teléfono</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarCelular" value-ticket="{{settingTicket.show_cellphone}}" name="show_cellphone">
                                    <label class="form-check-label" for="mostrarCelular">Mostrar celular</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarEmailEmpresa" value-ticket="{{settingTicket.show_email_company}}" name="show_email_company">
                                    <label class="form-check-label" for="mostrarEmailEmpresa">Mostrar email de la empresa</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarEmailSucursal" value-ticket="{{settingTicket.show_email_branch}}" name="show_email_branch">
                                    <label class="form-check-label" for="mostrarEmailSucursal">Mostrar email de la sucursal</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mostrarQR" value-ticket="{{settingTicket.show_qr}}" name="show_qr">
                                    <label class="form-check-label" for="mostrarQR">Mostrar código QR</label>
                                </div>
                            </div>

                            <!-- Inputs ocultos -->
                            <input type="hidden" id="empresa" value="Mi Empresa S.A. de C.V." />
                            <input type="hidden" id="direccion" value="Calle Falsa 123, Ciudad" />

                            <label class="hidden">Productos (uno por línea, formato: nombre|cant|precio|total):</label>
                            <textarea id="productos" class="hidden">
                                Bebida Energetica|2|15.00|30.00
                                Hamburguesa|1|50.00|50.00
                            </textarea>

                            <label class="hidden">Total:</label>
                            <input type="hidden" id="total" value="$80.00" />

                            <label>Contenido del QR (si aplica):</label>
                            <input type="text" id="contenidoQR" value-ticket="{{settingTicket.qr}}" placeholder="https://miempresa.com" class="form-control" name="qr">

                            <label>Mensaje de agradecimiento:</label>
                            <input type="text" id="mensaje" value-ticket="{{settingTicket.message}}" placeholder="¡Gracias por su compra!" class="form-control" name="message">

                            <button onclick="actualizarVistaPrevia()" type="button">Actualizar Vista Previa</button><br>
                            <button onclick="print_ticket()" class="btn btn-edit" type="button">Imprimir Ticket de
                                prueba</button>
                            <button class="btn btn-add">Actualizar Ticket</button>
                        </div>
                    </form>
                </div>
                <div class="col">
                    <div class="preview">
                        <h3>Vista Previa del Ticket</h3>
                        <div class="ticket-preview" id="vistaTicket">
                            <div class="ticket" id="headerTicket">
                                <!-- Aquí se genera el ticket headerTicket-->
                            </div>
                            <div class="qr" id="qrContainer" class="hidden"></div>
                            <div class="ticket" id="infoTicket">
                                <!-- Aquí se genera el ticket -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!--this is for create a barcode in the canva-->
<script src="/js/printer/JsBarcode.all.min.js"></script>
<script src="/js/printer/html2canvas.min.js"></script>
<script src="/js/printer/qrious.min.js"></script>

<script>
    function aplicarConfiguracionDelTicketDesdeValores() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][value-ticket]');
        checkboxes.forEach(checkbox => {
            const val = checkbox.getAttribute('value-ticket');
            checkbox.checked = val === '1' || val === 'true' || val === 'True' || val===true;
        });

        const inputs = document.querySelectorAll('input[type="text"][value-ticket], input[type="number"][value-ticket]');
        inputs.forEach(input => {
            const val = input.getAttribute('value-ticket');
            if (val !== null) {
                input.value = val;
            }
        });
    }

    async function cargarImpresoras() {
        try {
            const res = await fetch("http://localhost:5000/impresoras");
            const impresoras = await res.json();
            const select = document.getElementById("impresoraSelect");

            select.innerHTML = ""; // Limpiar contenido

            impresoras.forEach(impresora => {
                const option = document.createElement("option");
                option.value = impresora.name;
                option.textContent = `${impresora.name} (${impresora.type.split(',')[0]})`;
                select.appendChild(option);
            });
        } catch (e) {
            console.error("Error al cargar impresoras:", e);
        }
    }

    function actualizarVistaPrevia() {
        // Datos desde inputs ocultos
        const name_company = document.getElementById('name_company')?.value || '';
        const email_company = document.getElementById('email_company')?.value || '';
        const icon_company = document.getElementById('icon_company')?.src || '';

        const name_branch = document.getElementById('name_branch')?.value || '';
        const address = document.getElementById('address')?.value || '';
        const cell_phone = document.getElementById('cell_phone')?.value || '';
        const phone = document.getElementById('phone')?.value || '';
        const email_branch = document.getElementById('email_branch')?.value || '';

        const productos = document.getElementById('productos').value;
        const total = document.getElementById('total').value;
        const mostrarLogo = document.getElementById('mostrarLogo').checked;
        const mostrarFecha = document.getElementById('mostrarFecha').checked;
        const mostrarQR = document.getElementById('mostrarQR').checked;
        const mostrarNombreEmpresa = document.getElementById('mostrarNombreEmpresa').checked;
        const mostrarDireccion = document.getElementById('mostrarDireccion').checked;
        const contenidoQR = document.getElementById('contenidoQR').value;
        const mensaje = document.getElementById('mensaje').value;
        const ticketWidth = document.getElementById('ticketWidth').value;

        const show_employee = document.getElementById('show_employee').checked;
        const show_customer = document.getElementById('show_customer').checked;
        const mostrarSucursal = document.getElementById('mostrarSucursal').checked;
        const mostrarTelefono = document.getElementById('mostrarTelefono').checked;
        const mostrarCelular = document.getElementById('mostrarCelular').checked;
        const mostrarEmailEmpresa = document.getElementById('mostrarEmailEmpresa').checked;
        const mostrarEmailSucursal = document.getElementById('mostrarEmailSucursal').checked;
        let html = "";

        html += `<div style="text-align:center;">`;
        if (mostrarLogo && icon_company) {
            html += `<img src="${icon_company}" style="max-width:80px; margin-bottom:5px;"><br>`;
        }

        if (mostrarNombreEmpresa) {
            html += `<strong>${name_company}</strong><br>`;
        }

        if (mostrarSucursal && name_branch) {
            html += `${name_branch}<br>`;
        }
        if (mostrarDireccion && address) {
            html += `${address}<br>`;
        }
        html += `</div>`;

        if (mostrarFecha) {
            const fecha = new Date().toLocaleString();
            html += `<small>${fecha}</small><br>`;
        }

        html += `<div style="text-align:left;">`;
        if (show_employee) {
            html += `<small>Empleado: Nombre del Empleado</small><br>`;
        }

        if (show_customer) {
            html += `<small>Cliente: Nombre del Cliente</small><br>`;
        }
        html += `</div>`;



        // Tabla de productos
        html += `
            <table class="product-table" style="width:100%; margin-top:10px;">
            <thead>
                <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th></tr>
            </thead>
            <tbody>
        `;

        const lineas = productos.split('\n');
        lineas.forEach(linea => {
            const [nombre, cant, precio, subtotal] = linea.split('|');
            if (nombre && cant && precio && subtotal) {
                html += `<tr><td>${nombre}</td><td>${cant}</td><td>$${precio}</td><td>$${subtotal}</td></tr>`;
            }
        });

        html += `</tbody></table>`;

        html += `<div style="text-align:right;">`;
        html += `<div style="text-align:right; margin-top:10px;">TOTAL: ${total}</div>`;
        html += `</div>`;

        html += `
            <div style="text-align:center; margin: 15px 0;">
                <div style="font-size: 12px; font-weight: bold;">TOKEN DEL TICKET</div>
                <div style="font-size: 18px;">
                B875A3117D5A97C8
                </div>
            </div>
        `;

        if (mensaje) {
            html += `<div style="text-align:center; margin-top:10px;">${mensaje}</div>`;
        }


        document.getElementById('headerTicket').innerHTML = html;

        // Mostrar QR
        const qrContainer = document.getElementById('qrContainer');
        qrContainer.innerHTML = "";

        if (mostrarQR && contenidoQR.trim() !== "") {
            const qr = new QRious({
                value: contenidoQR,
                size: 120
            });

            const img = document.createElement('img');
            img.src = qr.toDataURL();
            qrContainer.appendChild(img);
        }

        let htmlLast = "<br>";
        if (mostrarEmailEmpresa) {
            htmlLast += `<small>${email_company}</small><br>`;
        }

        if (mostrarEmailSucursal) {
            htmlLast += `<small>${email_branch}</small><br>`;
        }

        if (mostrarTelefono) {
            htmlLast += `Tel: ${phone}<br>`;
        }

        if (mostrarCelular) {
            htmlLast += `Cel: ${cell_phone}<br>`;
        }
        document.getElementById('infoTicket').innerHTML = htmlLast;
    }


    window.onload = function () {
        aplicarConfiguracionDelTicketDesdeValores();
        actualizarVistaPrevia();
        cargarImpresoras();
    };



    function getTicketPlainText() {
        const ticketElement = document.getElementById("vistaTicket");
        let text = ticketElement.innerText || ticketElement.textContent;
        return text.trim();
    }

    function print_ticket() {
        const ticket = document.getElementById('vistaTicket');
        const impresora = document.getElementById("impresoraSelect").value;
        const ticketWidth = document.getElementById('ticketWidth').value;
        html2canvas(ticket, { scale: 1 }).then(canvas => {
            const imageData = canvas.toDataURL("image/png");
            console.log(imageData)
            fetch("http://localhost:5000/imprimir-imagen", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ image: imageData, impresora: impresora, ticketWidth: ticketWidth })
            })
                .then(res => res.json())
                .then(data => {
                    if(data.ok){
                        notificationMessage('✅','Ticket enviado correctamente')
                    }else{
                        notificationMessageError('❌', "Error al imprimir")
                    }
                })
                .catch(err => warningMessage('Error ❌',"Nos perdimos en el camino. No se pudo conectar al servidor de impresión."));
        });
    }
</script>